<script src="/socket.io/socket.io.js"></script>
<script>
  const socket = io();

  const envId       = <%= env.id %>;
  const activePlace = typeof activePlaceId !== 'undefined' ? activePlaceId : null;

  // Join the right room(s)
  socket.emit('joinEnv', envId);
  if (activePlace !== null) {
    socket.emit('joinPlace', { envId, placeId: activePlace });
  }

  // On lobby messages
  socket.on('lobbyMessage', msg => {
    if (!activePlace) {
      appendMessage(msg.username, msg.content);
    }
  });

  // On place messages
  socket.on('placeMessage', msg => {
    if (msg.placeId === activePlace) {
      appendMessage(msg.username, msg.content);
    }
  });

  // Form submit
  const form = document.querySelector('form[datasocket="chat"]');
  form.addEventListener('submit', e => {
    e.preventDefault();
    const input = form.querySelector('input[name="message"]');
    const content = input.value.trim();
    if (!content) return;
    if (activePlace !== null) {
      socket.emit('placeMessage', { envId, placeId: activePlace, content });
    } else {
      socket.emit('lobbyMessage', { envId, content });
    }
    input.value = '';
  });

  function appendMessage(username, content) {
    const container = document.getElementById('chat-history');
    const div = document.createElement('div');
    div.classList.add('mb-2');
    div.innerHTML = `<strong>${username}:</strong> ${content}`;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
  }
</script>
<%- include('../partials/header', { title, username }) %>

<div class="d-flex" style="height: calc(100vh - 64px);">
  
  <!-- 1ï¸âƒ£ LEFT: Places List -->
  <nav class="border-end p-3 environment-chat-places" style="width:20%; overflow-y:auto;">
    <h6>Places</h6>
    <ul class="list-group">
      <!-- Lobby link -->
      <li class="list-group-item <%= !activePlaceId ? 'active' : '' %>">
        <a href="/environments/<%= env.id %>/chat" class="text-decoration-none">ðŸ’¬ Lobby</a>
      </li>
      <% places.forEach(p => { %>
        <li class="list-group-item <%= activePlaceId===p.id ? 'active' : '' %>">
          <a href="/environments/<%= env.id %>/places/<%= p.id %>" class="text-decoration-none">
            <%= p.emoji %> <%= p.name %>
          </a>
        </li>
      <% }) %>
    </ul>
  </nav>

  <!-- 2ï¸âƒ£ CENTER: Chat History + Input -->
  <main class="flex-grow-1 d-flex flex-column p-3" style="overflow: hidden;">
    <!-- Chat history -->
    <div id="chat-history" class="flex-grow-1 overflow-auto mb-3">
      <% messages.forEach(msg => { %>
        <div class="mb-2">
          <strong><%= msg.username %>:</strong> <%= msg.content %>
        </div>
      <% }) %>
    </div>

    <!-- Chat input -->
    <form action="<%= activePlaceId 
        ? `/environments/${env.id}/places/${activePlaceId}/send`
        : `/environments/${env.id}/chat/send` %>"
      method="POST" class="d-flex" datasocket="chat"
    >
      <input type="text" name="message" class="form-control me-2" placeholder="Type your messageâ€¦" required>
      <button class="btn btn-primary">Send</button>
    </form>
  </main>

  <!-- 3ï¸âƒ£ RIGHT: Members List -->
  <aside class="border-start p-3" style="width: 20%; overflow-y: auto;">
    <h6>Members</h6>
    <ul class="list-group">
      <% members.forEach(m => { %>
        <li class="list-group-item d-flex justify-content-between align-items-center">
          <%= m.username %> 
          <span class="badge bg-secondary"><%= m.role %></span>
        </li>
      <% }) %>
    </ul>
  </aside>

</div>

<%- include('../partials/footer') %>
