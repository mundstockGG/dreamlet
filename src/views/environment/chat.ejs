<%- include('../partials/header', { title, username }) %>

<div class="d-flex" style="height: calc(100vh - 64px);">

  <nav class="border-end p-3 environment-chat-places d-flex flex-column" style="width:20%; overflow-y:auto; height:100%;">
    <h6>Places</h6>
    <ul class="list-group flex-grow-1">
      <% const lobbyPlace = places.find(p => p.id === env.id); %>
      <% if (lobbyPlace) { %>
      <li class="list-group-item <%= !activePlaceId ? 'active' : '' %>" style="padding:0;">
        <a href="#" class="lobby-link text-decoration-none d-flex align-items-center w-100 h-100"
           data-place-id="<%= lobbyPlace.id %>"
           style="padding:0.75rem 1.25rem; color:inherit;">
          <%= lobbyPlace.emoji %> <%= lobbyPlace.name %>
        </a>
      </li>
      <% } %>
      <% function renderPlaces(parentId,level) { %>
        <% places
            .filter(p => (p.parentId||0)===(parentId||0) && p.id!==env.id)
            .forEach(p => { %>
          <li class="list-group-item place-tree-level-<%= level %> <%= activePlaceId===p.id?'active':'' %>"
              data-parent-id="<%= p.parentId %>"
              style="padding:0;">
            <a href="#" class="place-link text-decoration-none d-flex align-items-center w-100 h-100"
               data-place-id="<%= p.id %>"
               style="padding:0.75rem 1.25rem; color:inherit;">
              <%= p.emoji %> <%= p.name %>
            </a>
          </li>
          <% renderPlaces(p.id, level+1) %>
        <% }) %>
      <% } %>
      <% renderPlaces(null,0) %>
    </ul>
    <div class="d-grid mt-3">
      <a href="/environments" class="btn btn-outline-danger">
        <i class="bi bi-door-open me-1"></i>Go Back
      </a>
    </div>
  </nav>

  <main class="flex-grow-1 d-flex flex-column p-3 position-relative" style="overflow:hidden;">
    <div id="chat-history" class="flex-grow-1 overflow-auto mb-3">
      <% messages.forEach(msg => { %>
        <% if (msg.type === 'action') { %>
          <div class="mb-2 chat-action chat-<%= msg.action_type %>">
            *<%= msg.username %> <%= msg.content %>
          </div>
        <% } else if (msg.type === 'roll') { %>
          <div class="mb-2 chat-roll">
            ðŸŽ² <strong><%= msg.username %></strong> <%= msg.content %>
          </div>
        <% } else { %>
          <div class="mb-2 chat-normal">
            <strong><%= msg.username %>:</strong> <%= msg.content %>
          </div>
        <% } %>
      <% }) %>
    </div>

    <span id="typing-indicator" class="small text-muted mb-2" style="display:none;"></span>
    <div class="chat-input-container position-relative w-100">
      <form id="chat-form" class="d-flex w-100 align-items-center">
        <div style="flex:1; position:relative;">
          <div id="slash-suggestions" class="slash-suggestions shadow-sm" style="display:none;"></div>
          <input type="text" name="message" class="form-control" placeholder="Type your messageâ€¦"
                 autocomplete="off" style="width:100%;" required>
        </div>
        <button class="btn btn-primary d-flex align-items-center ms-2" type="submit">
          <i class="bi bi-caret-right-fill me-1"></i><span>Send</span>
        </button>
      </form>
    </div>
  </main>

  <aside class="border-start p-3" style="width:20%; overflow-y:auto;">
    <h6>Members</h6>
    <ul class="list-group">
      <% members.forEach(m => { %>
      <li class="list-group-item d-flex justify-content-between align-items-center">
        <%= m.username %>
        <% if (m.role === 'owner') { %>
          <span title="Owner" style="font-size:1.1em; color:#888;">
            <!-- SVG icon omitted -->
          </span>
        <% } %>
      </li>
      <% }) %>
    </ul>
  </aside>
</div>

<!-- Roll Action Modal -->
<div class="modal fade" id="diceModal" tabindex="-1" aria-labelledby="diceModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="diceModalLabel">Roll Action</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <form id="diceForm">
          <div class="mb-3">
            <label for="diceDesc" class="form-label">Action Description</label>
            <input type="text" id="diceDesc" class="form-control" placeholder="e.g. search the chest" required>
          </div>
          <div class="mb-3">
            <label for="diceType" class="form-label">Dice Type</label>
            <select id="diceType" class="form-select">
              <option value="d6">d6 (1â€“6)</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="diceCount" class="form-label">How many?</label>
            <input id="diceCount" type="number" class="form-control" value="1" min="1" max="10" required>
          </div>
          <button type="submit" class="btn btn-primary">Roll</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  window.envId    = '<%= env.id %>';
  window.username = '<%= username %>';
</script>

<!-- 1) Load Bootstrap JS bundle so new bootstrap.Modal(...) works -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<!-- 2) Then load Socket.IO -->
<script src="/socket.io/socket.io.js"></script>
<!-- 3) Finally load our chat logic -->
<script src="/js/chat.js"></script>

<%- include('../partials/footer') %>
